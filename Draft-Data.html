<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sleeper Fantasy Draft Analyzer (Pre-loaded)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .loader {
            border-top-color: #3498db;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }
        @-webkit-keyframes spin {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .sortable {
            cursor: pointer;
            position: relative;
        }
        .sortable .sort-icon {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0.5;
            transition: opacity 0.2s;
        }
        .sortable:hover .sort-icon {
            opacity: 1;
        }
        .filter-input {
            width: 100%;
            background-color: #4a5568; /* gray-700 */
            border: 1px solid #718096; /* gray-600 */
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-7xl bg-gray-800 rounded-2xl shadow-2xl p-6 md:p-8">
        <div class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-white">Sleeper Multi-Draft Analyzer</h1>
            <p class="text-gray-400 mt-2">Analyze 5 pre-loaded seasons of draft history with sorting and filtering.</p>
        </div>

        <!-- Input Section -->
        <div class="flex justify-center mb-6">
            <button id="fetchDataBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-8 rounded-lg transition duration-200 shadow-md flex items-center justify-center text-lg">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                </svg>
                Analyze Drafts
            </button>
        </div>

        <!-- Status/Error Message -->
        <div id="status" class="text-center my-4"></div>

        <!-- Loader -->
        <div id="loader" class="hidden flex justify-center items-center my-8">
            <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-500 h-24 w-24"></div>
        </div>

        <!-- Results Section -->
        <div id="resultsContainer" class="hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 id="resultsHeader" class="text-2xl font-bold text-white">Combined Draft Results</h2>
                <button id="exportCsvBtn" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 shadow-md flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                    </svg>
                    Export to CSV
                </button>
            </div>
            <div class="overflow-x-auto bg-gray-800 rounded-lg border border-gray-700">
                <table class="min-w-full divide-y divide-gray-700">
                    <thead id="tableHeader" class="bg-gray-700">
                        <!-- Headers and Filters will be inserted here -->
                    </thead>
                    <tbody id="resultsBody" class="bg-gray-800 divide-y divide-gray-700">
                        <!-- Data will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const fetchDataBtn = document.getElementById('fetchDataBtn');
        const loader = document.getElementById('loader');
        const statusDiv = document.getElementById('status');
        const resultsContainer = document.getElementById('resultsContainer');
        const tableHeader = document.getElementById('tableHeader');
        const resultsBody = document.getElementById('resultsBody');
        const exportCsvBtn = document.getElementById('exportCsvBtn');

        let combinedData = [];
        let currentSort = { column: 'year', direction: 'desc' };
        let currentFilters = {};

        fetchDataBtn.addEventListener('click', handleFetchData);
        exportCsvBtn.addEventListener('click', exportToCsv);

        async function handleFetchData() {
            // **MODIFICATION:** Hardcoded league IDs
            const leagueIds = [
                '1124822402371428352',
                '986011172245692416',
                '842236252429324288',
                '650044825487384576',
                '604862459685191680'
            ];

            resetUI();
            loader.classList.remove('hidden');
            fetchDataBtn.disabled = true;

            try {
                for (const leagueId of leagueIds) {
                    displayStatus(`Processing League ID: ${leagueId}...`);
                    const usersResponse = await fetch(`https://api.sleeper.app/v1/league/${leagueId}/users`);
                    if (!usersResponse.ok) throw new Error(`Failed to fetch users for League ID ${leagueId}. Is it correct?`);
                    const users = await usersResponse.json();
                    const userMap = users.reduce((acc, user) => {
                        acc[user.user_id] = user.display_name;
                        return acc;
                    }, {});

                    const draftsResponse = await fetch(`https://api.sleeper.app/v1/league/${leagueId}/drafts`);
                    if (!draftsResponse.ok) throw new Error(`Failed to fetch draft for League ID ${leagueId}.`);
                    const leagueDrafts = await draftsResponse.json();
                    if (leagueDrafts.length === 0 || leagueDrafts[0].status !== 'complete') {
                        throw new Error(`No completed draft found for League ID ${leagueId}.`);
                    }
                    const draft = leagueDrafts[0];

                    displayStatus(`Fetching picks for ${draft.season} draft...`);
                    const picksResponse = await fetch(`https://api.sleeper.app/v1/draft/${draft.draft_id}/picks`);
                    if (!picksResponse.ok) throw new Error(`Failed to fetch picks for the ${draft.season} draft.`);
                    const picks = await picksResponse.json();

                    for (const pick of picks) {
                        const manager = userMap[pick.picked_by] || 'Unknown';
                        if (pick.metadata && pick.metadata.player_id) {
                            combinedData.push({
                                year: draft.season,
                                round: pick.round,
                                pick: pick.pick_no,
                                manager: manager,
                                player: `${pick.metadata.first_name} ${pick.metadata.last_name}`,
                                position: pick.metadata.position,
                                years_exp: pick.metadata.years_exp === null ? 0 : pick.metadata.years_exp
                            });
                        }
                    }
                }
                
                setupTableHeaders();
                renderTable();
                displayStatus('Analysis complete!', 'success');
                resultsContainer.classList.remove('hidden');

            } catch (error) {
                console.error('Error fetching data:', error);
                displayStatus(`Error: ${error.message}`, 'error');
            } finally {
                loader.classList.add('hidden');
                fetchDataBtn.disabled = false;
            }
        }

        function setupTableHeaders() {
            tableHeader.innerHTML = ''; // Clear existing
            const headers = [
                { key: 'year', name: 'Year' }, { key: 'round', name: 'Round' }, { key: 'pick', name: 'Pick' },
                { key: 'manager', name: 'Manager' }, { key: 'player', name: 'Player' }, { key: 'position', name: 'Position' },
                { key: 'years_exp', name: 'Years Exp.' }
            ];

            const headerRow = document.createElement('tr');
            const filterRow = document.createElement('tr');

            headers.forEach(({key, name}) => {
                const th = document.createElement('th');
                th.scope = 'col';
                th.className = 'px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider sortable';
                th.dataset.column = key;
                th.innerHTML = `${name} <span class="sort-icon"></span>`;
                th.addEventListener('click', () => handleSort(key));
                headerRow.appendChild(th);

                const filterTd = document.createElement('td');
                filterTd.className = 'px-2 py-1';
                const input = document.createElement('input');
                input.type = 'text';
                input.placeholder = `Filter ${name}...`;
                input.className = 'filter-input';
                input.dataset.column = key;
                input.addEventListener('keyup', handleFilter);
                filterTd.appendChild(input);
                filterRow.appendChild(filterTd);
            });

            tableHeader.appendChild(headerRow);
            tableHeader.appendChild(filterRow);
            updateSortIcons();
        }

        function handleSort(column) {
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
            }
            renderTable();
        }

        function handleFilter(event) {
            const column = event.target.dataset.column;
            const value = event.target.value.toLowerCase();
            currentFilters[column] = value;
            renderTable();
        }

        function renderTable() {
            // 1. Filter data
            let filteredData = combinedData.filter(item => {
                return Object.keys(currentFilters).every(key => {
                    const filterValue = currentFilters[key];
                    if (!filterValue) return true;
                    return String(item[key]).toLowerCase().includes(filterValue);
                });
            });

            // 2. Sort data
            filteredData.sort((a, b) => {
                const valA = a[currentSort.column];
                const valB = b[currentSort.column];
                
                let comparison = 0;
                if (valA > valB) {
                    comparison = 1;
                } else if (valA < valB) {
                    comparison = -1;
                }
                
                return currentSort.direction === 'asc' ? comparison : -comparison;
            });

            // 3. Display data
            displayData(filteredData);
            updateSortIcons();
        }

        function updateSortIcons() {
            document.querySelectorAll('.sortable').forEach(th => {
                const icon = th.querySelector('.sort-icon');
                if (th.dataset.column === currentSort.column) {
                    icon.innerHTML = currentSort.direction === 'asc' ? '&#9650;' : '&#9660;';
                    icon.style.opacity = '1';
                } else {
                    icon.innerHTML = '&#8693;';
                    icon.style.opacity = '0.5';
                }
            });
        }
        
        function displayData(data) {
            resultsBody.innerHTML = '';
            data.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-700 transition duration-150';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-white">${item.year}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${item.round}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${item.pick}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-white">${item.manager}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${item.player}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${item.position}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${item.years_exp}</td>
                `;
                resultsBody.appendChild(row);
            });
        }

        function exportToCsv() {
            if (combinedData.length === 0) {
                displayStatus('No data to export.', 'error');
                return;
            }
            
            const headers = Object.keys(combinedData[0]);
            const csvRows = [headers.join(',')];

            // Use the currently displayed (filtered and sorted) data for export
            const dataToExport = Array.from(resultsBody.querySelectorAll('tr')).map(row => {
                const cells = Array.from(row.querySelectorAll('td'));
                return {
                    year: cells[0].innerText,
                    round: cells[1].innerText,
                    pick: cells[2].innerText,
                    manager: cells[3].innerText,
                    player: cells[4].innerText,
                    position: cells[5].innerText,
                    years_exp: cells[6].innerText,
                };
            });

            for (const row of dataToExport) {
                const values = headers.map(header => {
                    const escaped = ('' + row[header]).replace(/"/g, '\\"');
                    return `"${escaped}"`;
                });
                csvRows.push(values.join(','));
            }

            const blob = new Blob([csvRows.join('\n')], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', `sleeper_multi_draft_analysis.csv`);
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
        
        function resetUI() {
            statusDiv.textContent = '';
            statusDiv.className = 'text-center my-4';
            resultsContainer.classList.add('hidden');
            resultsBody.innerHTML = '';
            tableHeader.innerHTML = '';
            combinedData = [];
            currentFilters = {};
            currentSort = { column: 'year', direction: 'desc' };
        }

        function displayStatus(message, type = 'info') {
            statusDiv.textContent = message;
            if (type === 'error') {
                statusDiv.className = 'text-center my-4 text-red-400 font-semibold';
            } else if (type === 'success') {
                statusDiv.className = 'text-center my-4 text-green-400 font-semibold';
            } else {
                statusDiv.className = 'text-center my-4 text-gray-400';
            }
        }
    </script>
</body>
</html>
